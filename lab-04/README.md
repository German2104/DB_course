# üöÄ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ4: –ò–Ω–¥–µ–∫—Å—ã, EXPLAIN –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ ¬´—Å–µ—Ä–≤–∏—Å–Ω—ã–µ —Ü–µ–Ω—Ç—Ä—ã¬ª –∏–∑ –õ–†1‚Äì–õ–†3. –ó–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω–æ, –∫–∞–∫ –≤—ã–±–∏—Ä–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –∫–∞–∫ —á–∏—Ç–∞—Ç—å –ø–ª–∞–Ω—ã `EXPLAIN ANALYZE` –¥–æ/–ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–∞, –∏ –∫–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å/—É—Å—Ç—Ä–∞–Ω—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏.

## –ß—Ç–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
- `indexes_explain.sql` ‚Äî —Ç—Ä–∏ –∫–µ–π—Å–∞ –∑–∞–ø—Ä–æ—Å–æ–≤: –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –ø–æ —Å–≤–æ–±–æ–¥–Ω—ã–º —Å–ª–æ—Ç–∞–º, –ø–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ –∏–º–µ–Ω–∏, –ø–æ–∏—Å–∫ –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π. –î–ª—è –∫–∞–∂–¥–æ–≥–æ: –ø–ª–∞–Ω –¥–æ –∏–Ω–¥–µ–∫—Å–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞, –ø–ª–∞–Ω –ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–∞. –í–∫–ª—é—á—ë–Ω `\timing`.
- `transactions.sql` ‚Äî —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –¥–≤—É—Ö —Å–µ—Å—Å–∏–π psql (T1/T2): dirty read (–Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ PostgreSQL), non-repeatable read, phantom read. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏.

## –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å
```bash
psql -f lab-02/schema.sql           # —Å—Ö–µ–º–∞
psql -f lab-02/seed.sql             # –¥–∞–Ω–Ω—ã–µ
psql -f lab-04/indexes_explain.sql  # –∏–Ω–¥–µ–∫—Å—ã + –ø–ª–∞–Ω—ã
psql -f lab-04/transactions.sql     # –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π
```
–î–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω—É–∂–Ω–æ –¥–≤–∞ –æ–∫–Ω–∞ psql: —Å–ª–µ–¥—É–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º `Session T1` –∏ `Session T2`.

## –ü–æ–¥—Ä–æ–±–Ω–æ: `indexes_explain.sql`
- –í–∫–ª—é—á–∞–µ—Ç `\timing on` ‚Äî —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã.
- –û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –∏–Ω–¥–µ–∫—Å—ã (`DROP INDEX IF EXISTS ...`) –∏ –≤–∫–ª—é—á–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pg_trgm` (—É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫ –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ).

### –ö–µ–π—Å 1: —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –ø–æ –¥–∞—Ç–µ
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è SELECT —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `center_id`, `is_booked = FALSE`, `starts_at BETWEEN ...` –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ `starts_at`. –ü–µ—Ä–≤—ã–π `EXPLAIN ANALYZE` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω (–æ–∂–∏–¥–∞–µ–º Seq Scan).
- –°–æ–∑–¥–∞—ë—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω—ã–π btree-–∏–Ω–¥–µ–∫—Å `idx_time_slots_free_by_center_start` –Ω–∞ `(center_id, starts_at)` —Å —É—Å–ª–æ–≤–∏–µ–º `WHERE is_booked = FALSE` ‚Äî —ç–∫–æ–Ω–æ–º–∏—Ç –º–µ—Å—Ç–æ –∏ —É—Å–∫–æ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π `EXPLAIN ANALYZE` –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å Index/Bitmap Index Scan –∏ –º–µ–Ω—å—à–µ–µ –≤—Ä–µ–º—è.

### –ö–µ–π—Å 2: –ø–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ –Ω–∞—á–∞–ª—É –∏–º–µ–Ω–∏ (case-insensitive)
- SELECT –ø–æ `users` —Å `role = 'technician'` –∏ `lower(full_name) LIKE 'd%'`, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `full_name`. –ü–µ—Ä–≤—ã–π –ø–ª–∞–Ω ‚Äî Seq Scan + Sort.
- –ò–Ω–¥–µ–∫—Å –≤—ã—Ä–∞–∂–µ–Ω–∏—è `idx_users_role_full_name_lower` –Ω–∞ `(role, lower(full_name))` –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∏ —Ñ–∏–ª—å—Ç—Ä, –∏ –ø–æ—Ä—è–¥–æ–∫.
- –í—Ç–æ—Ä–æ–π –ø–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ Index Scan –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.

### –ö–µ–π—Å 3: –ø–æ–¥—Å—Ç—Ä–æ–∫–∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º + –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä–∞–º
- SELECT —Å `ILIKE '%–∑–≤—É–∫%'`, JOIN –Ω–∞ —Ü–µ–Ω—Ç—Ä—ã –∏ GROUP BY `center, priority`. –ü–µ—Ä–≤—ã–π –ø–ª–∞–Ω ‚Äî Seq Scan –ø–æ tickets.
- –°–æ–∑–¥–∞—ë—Ç—Å—è GIN-–∏–Ω–¥–µ–∫—Å `idx_tickets_problem_description_trgm` –ø–æ `problem_description` —Å `gin_trgm_ops` (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è LIKE/ILIKE).
- –í—Ç–æ—Ä–æ–π –ø–ª–∞–Ω ‚Äî Bitmap Index Scan + Hash/Seq –Ω–∞ JOIN, –≤—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å—Å—è.
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–Ω—Ü–µ –Ω–∞–ø–æ–º–∏–Ω–∞—é—Ç —Å–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –ø–ª–∞–Ω–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–∞.

## –ü–æ–¥—Ä–æ–±–Ω–æ: `transactions.sql`
- –°–æ–∑–¥–∞—ë—Ç —Ç–µ—Å—Ç–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É `tx_demo` –∏ —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ö–µ–º—É. –°–∫—Ä–∏–ø—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π (`DROP TABLE IF EXISTS`).
- –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ç—Ä–µ–±—É—é—Ç –¥–≤—É—Ö —Å–µ—Å—Å–∏–π psql. –ö–æ–º–∞–Ω–¥—ã –¥–ª—è T1 –∏ T2 –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö, –∫–æ–ø–∏—Ä—É–π—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é.

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Dirty read (–Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è)
- T1: `BEGIN; UPDATE ...` –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å, –Ω–æ –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç.
- T2: `SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED; SELECT ...` ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–∏–¥–∏—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (`new`), –ø–æ—Ç–æ–º—É —á—Ç–æ PostgreSQL –Ω–µ –¥–∞—ë—Ç —á–∏—Ç–∞—Ç—å –≥—Ä—è–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
- T1: `ROLLBACK;` ‚Äî –æ—Ç–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è.

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Non-repeatable read
- –°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ —Å—Ç—Ä–æ–∫–∏ `id=1` –≤ `new` –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞.
- –í READ COMMITTED: T1 —á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `new`; T2 –∫–æ–º–º–∏—Ç–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ `done`; T1 –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–∏—Ç–∞–µ—Ç –∏ –≤–∏–¥–∏—Ç `done` –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Äî –ø—Ä–∏–º–µ—Ä non-repeatable read.
- –ü–æ–≤—Ç–æ—Ä —Å REPEATABLE READ: T1 —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Å–Ω–∏–º–æ–∫ –∏ –≤–∏–¥–∏—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ T2 –æ–±–Ω–æ–≤–∏–ª —Å—Ç—Ä–æ–∫—É. –ó–∞—â–∏—Ç–∞ –æ—Ç non-repeatable read.

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Phantom read
- –í READ COMMITTED: T1 —Å—á–∏—Ç–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Å `priority >= 2`; T2 –≤—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É —Å `priority >= 2`; T1 –ø–æ–≤—Ç–æ—Ä—è–µ—Ç COUNT –∏ –ø–æ–ª—É—á–∞–µ—Ç –±–æ–ª—å—à–µ–µ —á–∏—Å–ª–æ ‚Äî —Ñ–∞–Ω—Ç–æ–º.
- –í SERIALIZABLE: T1 —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Å–Ω–∏–º–æ–∫, T2 –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å serialization failure, –ª–∏–±–æ –≤—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ–π–¥—ë—Ç, –Ω–æ T1 –≤—Å—ë —Ä–∞–≤–Ω–æ —É–≤–∏–¥–∏—Ç —Å—Ç–∞—Ä—ã–π —Å—á—ë—Ç—á–∏–∫. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —Ñ–∞–Ω—Ç–æ–º—ã —É—Å—Ç—Ä–∞–Ω—è—é—Ç—Å—è (–≤ REPEATABLE READ ‚Äî —á–µ—Ä–µ–∑ –ø—Ä–µ–¥–∏–∫–∞—Ç–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏).

### –û—á–∏—Å—Ç–∫–∞
- –í –∫–æ–Ω—Ü–µ –µ—Å—Ç—å –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ `DROP TABLE tx_demo;` ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã.

## –ò—Ç–æ–≥
- –ü–æ–∫–∞–∑–∞–Ω—ã —Ç—Ä–∏ –≤–∏–¥–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤/–≤—Ä–µ–º–µ–Ω–∏ —Å `EXPLAIN ANALYZE`.
- –ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏ –∏ —É—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏—Ö –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç, –±–µ–∑ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ö–µ–º—ã —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö —Ü–µ–Ω—Ç—Ä–æ–≤.
