# üö¶ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ3: –ü—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã

–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –±–∞–∑—ã –∏–∑ –õ–†1‚Äì–õ–†2 (—Å–µ—Ä–≤–∏—Å–Ω—ã–µ —Ü–µ–Ω—Ç—Ä—ã). –í —ç—Ç–æ–π —Ä–∞–±–æ—Ç–µ –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ PL/pgSQL: –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, –≤—ã—á–∏—Å–ª–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏.

## –ß—Ç–æ –µ—Å—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
- `procedures_functions_triggers.sql` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–æ—Ü–µ–¥—É—Ä—É –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã, –æ—á–∏—â–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–µ—Ä—Å–∏–∏, –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏.
- `demo.sql` ‚Äî –ø–æ—à–∞–≥–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π —É—Å–ø–µ—à–Ω—ã–π –ø–æ—Ç–æ–∫ –∏ –æ—à–∏–±–∫–∏ (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –±—Ä–æ–Ω—å), –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π –∏ —Ä–∞–±–æ—Ç—É —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤.

## –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å (psql)
```bash
psql -f lab-02/schema.sql                     # —Å—Ö–µ–º–∞
psql -f lab-02/seed.sql                       # —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
psql -f lab-03/procedures_functions_triggers.sql
psql -f lab-03/demo.sql                       # –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
```

–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –æ–±—â–∏–π —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:
```bash
./run_lab.sh 3
```

## –ü–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ –∫–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç

### –û—á–∏—Å—Ç–∫–∞ (–≤ –Ω–∞—á–∞–ª–µ `procedures_functions_triggers.sql`)
- `DROP TRIGGER IF EXISTS ...` –∏ `DROP FUNCTION/PROCEDURE IF EXISTS ... CASCADE` ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª–Ω—è—Ç—å —Å–∫—Ä–∏–ø—Ç –±–µ–∑ —Ä—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏, —É–¥–∞–ª—è—è —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ `appointments` –∏ `tickets`.

### –§—É–Ω–∫—Ü–∏—è `fn_is_ticket_active(p_ticket_id BIGINT) RETURNS BOOLEAN`
- –í—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞; –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `RB100` —Å —Ç–µ–∫—Å—Ç–æ–º ¬´–¢–∏–∫–µ—Ç % –Ω–µ –Ω–∞–π–¥–µ–Ω¬ª.
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `TRUE`, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –≤ `('done','cancelled')`, –∏–Ω–∞—á–µ `FALSE`. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ¬´–∂–∏–≤–æ—Å—Ç–∏¬ª —Ç–∏–∫–µ—Ç–∞.

### –§—É–Ω–∫—Ü–∏—è `fn_technician_utilization(p_technician_id BIGINT) RETURNS TABLE`
- –°—á–∏—Ç–∞–µ—Ç –ø–æ `time_slots` –º–∞—Å—Ç–µ—Ä–∞:
  - `total_slots` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤.
  - `booked_slots` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç—ã—Ö (`is_booked`).
  - `utilization_percent` ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–Ω—è—Ç—ã—Ö —Å–ª–æ—Ç–æ–≤, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 2 –∑–Ω–∞–∫–æ–≤; –µ—Å–ª–∏ —Å–ª–æ—Ç–æ–≤ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `0`.
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å —ç—Ç–∏–º–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏ (TABLE-—Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ `RETURN QUERY`).

### –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ `book_ticket_with_slot(p_client_email, p_device_serial, p_problem, p_priority, p_slot_id)`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∞–∫—Ç–∏–≤–µ–Ω –∏ –µ–≥–æ —Ä–æ–ª—å ‚Äî `client`; –∏–Ω–∞—á–µ `RAISE EXCEPTION` —Å –∫–æ–¥–æ–º `RB001`.
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —É –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å –¥–∞–Ω–Ω—ã–º —Å–µ—Ä–∏–π–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º; –∏–Ω–∞—á–µ `RB002`.
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É —Å–ª–æ—Ç–∞ `FOR UPDATE`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–∫–∏, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ (`RB003`) –∏ –Ω–µ–∑–∞–Ω—è—Ç–æ—Å—Ç—å (`RB004`).
- –°–æ–∑–¥–∞—ë—Ç —Ç–∏–∫–µ—Ç (`tickets`) —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º.
- –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏—ë–º (`appointments`) —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å–ª–æ—Ç–æ–º –∏ —Å—Ç–∞—Ç—É—Å–æ–º `booked`.
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `EXCEPTION`:
  - `unique_violation` ‚Üí `RB010` —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –ø–æ –¥—É–±–ª–∏–∫–∞—Ç–∞–º/—Å–ª–æ—Ç—É.
  - `foreign_key_violation` ‚Üí `RB011` —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –ø–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º —Å—É—â–Ω–æ—Å—Ç—è–º.
  - `check_violation` ‚Üí `RB012`.
- –í–µ—Å—å –ø–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã; –µ—Å–ª–∏ –æ—à–∏–±–∫–∞, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –±–ª–æ–∫–∞ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è.

### –¢—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ `appointments`
- –§—É–Ω–∫—Ü–∏—è `validate_appointment()` (BEFORE INSERT/UPDATE):
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–∞; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—à–∏–±–∫–∞.
  - –ó–∞–ø—Ä–µ—â–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —É–∂–µ –∑–∞–Ω—è—Ç—ã–π —Å–ª–æ—Ç (–≤—Å—Ç–∞–≤–∫–∞ –∏–ª–∏ —Å–º–µ–Ω–∞ `slot_id`).
  - –¢—Ä–µ–±—É–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–ø–∏—Å–∏ —Å –º–∞—Å—Ç–µ—Ä–æ–º —Å–ª–æ—Ç–∞; –∏–Ω–∞—á–µ –æ—à–∏–±–∫–∞.
  - –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç `center_id` –∏–∑ —Å–ª–æ—Ç–∞, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è.
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ç–∏–∫–µ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –∑–∞–∫—Ä—ã—Ç (`done/cancelled`); –∏–Ω–∞—á–µ –æ—à–∏–±–∫–∞.
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `NEW` –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏.
- –§—É–Ω–∫—Ü–∏—è `set_slot_booked()` (AFTER INSERT):
  - –ü–æ–º–µ—á–∞–µ—Ç `time_slots.is_booked = TRUE` –¥–ª—è –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞. –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–∂–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏.
- –§—É–Ω–∫—Ü–∏—è `free_slot_after_delete()` (AFTER DELETE):
  - –°–Ω–∏–º–∞–µ—Ç –±—Ä–æ–Ω—å `is_booked = FALSE`, –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞ (–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Å–ª–æ—Ç–∞).

### –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ `tickets`
- –§—É–Ω–∫—Ü–∏—è `touch_ticket_updated_at()` (BEFORE UPDATE):
  - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å `status` –∏–ª–∏ `priority`, –æ–±–Ω–æ–≤–ª—è–µ—Ç `last_updated_at := now()`; –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ `NEW`.

### –ü—Ä–∏–≤—è–∑–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
- `trg_validate_appointment` ‚Äî BEFORE INSERT/UPDATE ON `appointments` ‚Üí `validate_appointment()`.
- `trg_mark_slot_booked` ‚Äî AFTER INSERT ON `appointments` ‚Üí `set_slot_booked()`.
- `trg_release_slot` ‚Äî AFTER DELETE ON `appointments` ‚Üí `free_slot_after_delete()`.
- `trg_touch_ticket` ‚Äî BEFORE UPDATE ON `tickets` ‚Üí `touch_ticket_updated_at()`.

## –ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç `demo.sql` (—Å—Ç—Ä–æ–∫–∞ –∑–∞ —Å—Ç—Ä–æ–∫–æ–π)
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å `schema.sql`, `seed.sql`, `procedures_functions_triggers.sql` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º.
- –ë–ª–æ–∫ 1 ‚Äî —É—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
  - `CALL book_ticket_with_slot('alice.johnson@example.com', 'A-GS22-009', '–ù–µ –ª–æ–≤–∏—Ç —Å–µ—Ç—å...', 'high', 5);`
    - –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ/—Å–ª–æ—Ç, —Å–æ–∑–¥–∞—ë—Ç —Ç–∏–∫–µ—Ç –∏ –∑–∞–ø–∏—Å—å, —Ç—Ä–∏–≥–≥–µ—Ä—ã –æ—Ç–º–µ—á–∞—é—Ç —Å–ª–æ—Ç –∑–∞–Ω—è—Ç—ã–º.
  - `SELECT slot_id, is_booked FROM time_slots WHERE slot_id = 5;`
    - –ü—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ–ª–µ `is_booked` —Å—Ç–∞–ª–æ `TRUE`.
- –ë–ª–æ–∫ 2 ‚Äî –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –±—Ä–æ–Ω–∏:
  - DO-–±–ª–æ–∫ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–Ω–æ–≤–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç `5` –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.
  - –í `EXCEPTION WHEN OTHERS` –ª–æ–≤–∏—Ç—Å—è –æ—à–∏–±–∫–∞ `RB004`, –≤—ã–≤–æ–¥–∏—Ç—Å—è `NOTICE '–û–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞: %'`.
- –ë–ª–æ–∫ 3 ‚Äî –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π:
  - `SELECT fn_is_ticket_active(1)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–∫—Ä—ã—Ç –ª–∏ —Ç–∏–∫–µ—Ç `1`.
  - `SELECT * FROM fn_technician_utilization(...)` ‚Äî —Ä–∞—Å—á—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–∞ –î–º–∏—Ç—Ä–∏—è –ø–æ –µ–≥–æ `technician_id`.
- –ë–ª–æ–∫ 4 ‚Äî —Ä–∞–±–æ—Ç–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è:
  - `DELETE FROM appointments WHERE slot_id = 5;` ‚Äî —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å.
  - `SELECT slot_id, is_booked FROM time_slots WHERE slot_id = 5;` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ `is_booked` —Å–±—Ä–æ—à–µ–Ω –≤ `FALSE`.

## –ò—Ç–æ–≥
- –í—Å–µ –æ–±—ä–µ–∫—Ç—ã –∑–∞–≤—è–∑–∞–Ω—ã –Ω–∞ —Å—Ö–µ–º—É –∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –õ–†2, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π PostgreSQL –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
- –¢—Ä–∏–≥–≥–µ—Ä—ã –∑–∞—â–∏—â–∞—é—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å (–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–æ–≤/–º–∞—Å—Ç–µ—Ä–æ–≤/—Ç–∏–∫–µ—Ç–æ–≤), –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –±–∏–∑–Ω–µ—Å-–ø–æ—Ç–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, —Ñ—É–Ω–∫—Ü–∏–∏ –¥–∞—é—Ç —Å–µ—Ä–≤–∏—Å–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
- –ë–∏–∑–Ω–µ—Å-–∫–æ–¥—ã –æ—à–∏–±–æ–∫ `RB001‚ÄìRB012, RB100` –ø–æ–∑–≤–æ–ª—è—é—Ç –ª–æ–≤–∏—Ç—å –ø—Ä–∏—á–∏–Ω—ã –∏ –≤—ã–≤–æ–¥–∏—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
